import pandas as pd
import os

def add_data():
    file_path = '2024_전기공사_통합데이터.xlsx'
    
    if not os.path.exists(file_path):
        print("파일이 없습니다.")
        return

    df = pd.read_excel(file_path)
    current_len = len(df)
    
    # 3차 배치 (5건) - 2026/01/21 추가 요청
    new_items = [
        {
            # Image 0: 생활SOC 학교시설 복합화(대전고) 사업 전기공사
            # 투찰금액: 913,733,286, 투찰률: 90.442%
            # 공사예정금액: 1,107,821,000 -> 역산 시 차이 큼 (관급자재 추정) -> 보정
            '공고명': '생활SOC 학교시설 복합화(대전고) 사업 전기공사',
            '발주처': '대전광역시',
            '공고일': '2026-01-20',
            '낙찰금액': 913733286,
            '낙찰률': 90.442,
            '기초금액_화면': 1107821000, 
            '비고': '관급자재_보정'
        },
        {
            # Image 1: 2026년 공원 전기시설 보수 단가공사(북부권역)
            # 투찰금액: 15,050,034, 투찰률: 90.189%
            # 공사예정금액: 80,000,000 -> 단가계약 총액한도임. 실제 기초금액은 1500만원대. -> 보정
            '공고명': '2026년 공원 전기시설 보수 단가공사(북부권역)',
            '발주처': '경기도 평택시',
            '공고일': '2026-01-19',
            '낙찰금액': 15050034,
            '낙찰률': 90.189,
            '기초금액_화면': 80000000,
            '비고': '단가계약_보정'
        },
        {
            # Image 2: 나운3동 SOC복합시설 조성 전기공사 감리용역
            # 투찰금액: 37,821,520, 투찰률: 88.082%
            # 감리용역은 공사와 특성이 다르지만 요청으로 추가. 기초금액 불분명 -> 역산 보정
            '공고명': '나운3동 SOC복합시설 조성 전기공사 감리용역',
            '발주처': '전북특별자치도 군산시',
            '공고일': '2026-01-19',
            '낙찰금액': 37821520,
            '낙찰률': 88.082,
            '기초금액_화면': 0, # 확인불가
            '비고': '감리용역_보정'
        },
        {
            # Image 3: 삼척 임원출장소 신축공사[전기공사]
            # 투찰금액: 348,947,496, 투찰률: 90.42%
            # 공사예정금액: 455,849,000 -> 역산 시 3.8억 vs 4.5억 차이 -> 보정
            '공고명': '삼척 임원출장소 신축공사[전기공사]',
            '발주처': '강원특별자치도 삼척시',
            '공고일': '2026-01-17',
            '낙찰금액': 348947496,
            '낙찰률': 90.42,
            '기초금액_화면': 455849000,
            '비고': '관급자재_보정'
        },
        {
            # Image 4: 발연리(계룡아파트 주변)도로(중2-23호) 전기공사
            # 투찰금액: 75,716,240, 투찰률: 90.297%
            # 공사예정금액(기초): 84,450,000
            # 역산(예가): 83,852,442
            # 사정율: 99.29% (정상 범위) -> 화면 금액 사용
            '공고명': '발연리(계룡아파트 주변)도로(중2-23호) 전기공사',
            '발주처': '충청남도 예산군',
            '공고일': '2026-01-16',
            '낙찰금액': 75716240,
            '낙찰률': 90.297,
            '기초금액_화면': 84450000,
            '비고': '정상'
        }
    ]
    
    rows_to_add = []
    
    for item in new_items:
        # 1. 예정가격 역산
        est_price = int(item['낙찰금액'] / (item['낙찰률'] / 100))
        
        # 2. 기초금액 결정
        # 화면상 금액과 역산(예가)의 차이가 10% 이내면 정상으로 간주
        if item['기초금액_화면'] > 0:
            diff_ratio = abs(item['기초금액_화면'] - est_price) / est_price
        else:
            diff_ratio = 999
            
        if diff_ratio < 0.1:
            base_price = item['기초금액_화면']
            adj_rate = (est_price / base_price) * 100
            final_note = "정상"
        else:
            # 차이가 크면(단가계약, 자재포함 등) 통계 오염 방지를 위해 보정
            base_price = est_price 
            adj_rate = 100.0
            final_note = f"{item['비고']}-보정됨"
            
        print(f"Added: {item['공고명']} | 사정율: {adj_rate:.2f}% ({final_note})")

        row = {
            '공고명': item['공고명'],
            '발주처': item['발주처'],
            '공고일': item['공고일'],
            '기초금액': base_price,
            '예정가격': est_price,
            '낙찰금액': item['낙찰금액'],
            '낙찰하한율': 87.745,
            '낙찰률': item['낙찰률'],
            '사정율': adj_rate
        }
        rows_to_add.append(row)
    
    new_df = pd.DataFrame(rows_to_add)
    merged_df = pd.concat([df, new_df], ignore_index=True)
    
    merged_df.to_excel(file_path, index=False)
    print(f"Total rows: {len(merged_df)}")

if __name__ == "__main__":
    add_data()
