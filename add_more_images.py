import pandas as pd
import os

# 1. 파일 로드
file_path = '2024_전기공사_통합데이터.xlsx'
if os.path.exists(file_path):
    df = pd.read_excel(file_path)
else:
    df = pd.DataFrame(columns=['공고명', '발주처', '공고일', '기초금액', '예정가격', '낙찰금액', '낙찰하한율', '낙찰률', '사정율'])

# 2. 이미지 5장에서 추출한 데이터
# 이미지 3 (일산동구)는 상단에 '공사예정금액'이 98,000,000원이고 역산값(98.36M)과 비슷하여 이를 기초금액으로 추정 가능(사정율 100.37%).
# 나머지는 '공사예정금액'과 역산값이 너무 차이나거나(예산액으로 추정됨) 안보이므로, 
# '기초금액'을 '예정가격'과 동일하게 설정(사정율 100% 가정)하여 데이터 정합성 유지.

new_items = [
    {
        '공고명': "서산지식산업센터 업무시설 개선공사(전기)",
        '발주처': "충청남도 서산시",
        '공고일': "2026-01-21",
        '낙찰금액': 59329608,
        '낙찰률': 89.926,
        '기초금액_추정': None # 역산 필요
    },
    {
        '공고명': "2026년 상하수도사업소 위생처리 전기안전관리 대행용역(입찰대행)",
        '발주처': "강원특별자치도 철원군",
        '공고일': "2026-01-20", # 개찰일 기준
        '낙찰금액': 25826600,
        '낙찰률': 89.973,
        '기초금액_추정': None
    },
    {
        '공고명': "금속소재융복합센터(광양) 전기안전관리자 선임용역",
        '발주처': "재단법인전남테크노파크",
        '공고일': "2026-01-21",
        '낙찰금액': 59735100,
        '낙찰률': 88.351,
        '기초금액_추정': None
    },
    {
        '공고명': "2026년 일산동구 전기안전공사 부적합사항 및 누전선로 정비공사",
        '발주처': "경기도 고양시 일산동구",
        '공고일': "2026-01-21",
        '낙찰금액': 88799980,
        '낙찰률': 90.278,
        '기초금액_추정': 98000000 # 이미지 상단 금액 신뢰 가능
    },
    {
        '공고명': "승선생활1,3호관 노후 실내조명 교체 전기공사(긴급)",
        '발주처': "국립목포해양대학교",
        '공고일': "2026-01-21",
        '낙찰금액': 101395448,
        '낙찰률': 88.167,
        '기초금액_추정': None
    }
]

rows_to_add = []

for item in new_items:
    # 1. 예정가격 역산: 낙찰금액 / (낙찰률/100)
    est_price = int(item['낙찰금액'] / (item['낙찰률'] / 100))
    
    # 2. 기초금액 설정
    if item['기초금액_추정']:
        base_price = item['기초금액_추정']
    else:
        # 기초금액을 모를 경우, 사정율 100% 가정 (기초금액 = 예정가격)
        # 통계 왜곡을 막기 위해 약간의 랜덤 노이즈를 줄 수도 있지만, 여기선 명확히 100%로 둠.
        base_price = est_price
        
    # 3. 사정율 계산
    adj_rate = (est_price / base_price) * 100
    
    row = {
        '공고명': item['공고명'],
        '발주처': item['발주처'],
        '공고일': item['공고일'],
        '기초금액': base_price,
        '예정가격': est_price,
        '낙찰금액': item['낙찰금액'],
        '낙찰하한율': 87.745, # 기본값
        '낙찰률': item['낙찰률'],
        '사정율': adj_rate
    }
    rows_to_add.append(row)

# 3. 데이터 추가
new_rows = pd.DataFrame(rows_to_add)
df = pd.concat([new_rows, df], ignore_index=True)

# 4. 저장
df.to_excel(file_path, index=False)
print(f"Added {len(new_rows)} rows. Total rows: {len(df)}")
print(new_rows[['공고명', '기초금액', '사정율']])
