import pandas as pd
import os

# 1. 파일 로드
file_path = '2024_전기공사_통합데이터.xlsx'
if os.path.exists(file_path):
    df = pd.read_excel(file_path)
else:
    df = pd.DataFrame(columns=['공고명', '발주처', '공고일', '기초금액', '예정가격', '낙찰금액', '낙찰하한율', '낙찰률', '사정율'])

# 2. 이미지 5장에서 추출한 데이터 (Batch 2)
new_items = [
    {
        '공고명': "2026년 상반기 교통안전시설물 유지보수 단가공사(전기)-2권역",
        '발주처': "경기도 시흥시",
        '공고일': "2026-01-21",
        '낙찰금액': 134942591,
        '낙찰률': 90.208,
        '기초금액_화면': 150000000 # 화면상 공사예정금액
    },
    {
        '공고명': "2026년 상반기 교통안전시설물 유지보수 단가공사(전기)-1권역",
        '발주처': "경기도 시흥시",
        '공고일': "2026-01-21",
        '낙찰금액': 136108370,
        '낙찰률': 90.201,
        '기초금액_화면': 150000000
    },
    {
        '공고명': "숭의여자중학교 전력간선 및 기타 전기공사 소액수의 견적 공고",
        '발주처': "서울특별시동작교육청 숭의여자중학교",
        '공고일': "2026-01-21",
        '낙찰금액': 141790950,
        '낙찰률': 90.441,
        '기초금액_화면': 213945000 # *주의: 투찰금액(1.4억)과 차이가 큼. 관급자재 포함 추정.
    },
    {
        '공고명': "보수초 급식조리실 환기설비개선 전기공사",
        '발주처': "부산광역시교육청 부산광역시서부교육지원청",
        '공고일': "2026-01-21",
        '낙찰금액': 33876375,
        '낙찰률': 90.264,
        '기초금액_화면': 37549000
    },
    {
        '공고명': "고전면 기초생활거점조성사업 행정문화복합센터 전기공사",
        '발주처': "한국농어촌공사 경남지역본부 하동남해지사",
        '공고일': "2026-01-21",
        '낙찰금액': 231396253,
        '낙찰률': 88.633,
        '기초금액_화면': 458798000 # *주의: 투찰금액(2.3억)과 차이가 큼.
    }
]

rows_to_add = []

for item in new_items:
    # 1. 예정가격 역산
    est_price = int(item['낙찰금액'] / (item['낙찰률'] / 100))
    
    # 2. 기초금액 결정
    # 화면상 금액과 역산 금액의 차이가 10% 이내면 화면상 금액을 기초금액으로 사용 (신뢰)
    # 차이가 크면(관급자재 등 포함된 경우), 데이터 왜곡 방지를 위해 '예정가격'을 '기초금액'으로 가정 (사정율 100% 처리)
    
    diff_ratio = abs(item['기초금액_화면'] - est_price) / est_price
    
    if diff_ratio < 0.1:
        base_price = item['기초금액_화면']
        adj_rate = (est_price / base_price) * 100
        note = "정상"
    else:
        base_price = est_price # 왜곡 방지를 위한 보정
        adj_rate = 100.0
        note = "보정됨(자재비제외추정)"

    row = {
        '공고명': item['공고명'],
        '발주처': item['발주처'],
        '공고일': item['공고일'],
        '기초금액': base_price,
        '예정가격': est_price,
        '낙찰금액': item['낙찰금액'],
        '낙찰하한율': 87.745,
        '낙찰률': item['낙찰률'],
        '사정율': adj_rate
    }
    rows_to_add.append(row)
    print(f"Added: {item['공고명'][:10]}... | 사정율: {adj_rate:.2f}% ({note})")

# 3. 데이터 추가
new_rows = pd.DataFrame(rows_to_add)
df = pd.concat([new_rows, df], ignore_index=True)

# 4. 저장
df.to_excel(file_path, index=False)
print(f"Total rows: {len(df)}")
